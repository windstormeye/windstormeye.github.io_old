<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="也就骑个车，顺便写点码，再去看看景"><title>搞事情之 Vapor 初探 | PJHubs</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">搞事情之 Vapor 初探</h1><a id="logo" href="/.">PJHubs</a><p class="description">也就骑个车，顺便写点码，再去看看景</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa undefined"> 文章</i></a><a href="/archives/"><i class="fa undefined"> 总览</i></a><a href="/photograph/"><i class="fa undefined"> 摄影</i></a><a href="/about/"><i class="fa undefined"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">搞事情之 Vapor 初探</h1><div class="post-meta">2019-05-04</div><div class="post-content"><blockquote>
<p>搞事情系列文章主要是为了继续延续自己的 “T” 字形战略所做，同时也代表着毕设相关内容的学习总结。本文是 <code>Vapor</code> 部分的第一篇，主要记录了第一次上手 <code>Swift</code> 最火的服务端框架 <code>Vapor</code> 所遇到的问题、思考和总结。</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>从 <code>SwiftNIO</code> 开源后，之前对 <code>Swift Server Side</code> 完全不关心的我再也按耐不住了！尤其是还看到了<a target="_blank" rel="noopener" href="https://medium.com/@rymcol/benchmarks-for-the-top-server-side-swift-frameworks-vs-node-js-24460cfe0beb">这篇文章</a>，我相信这个文章肯定大部分同学都浏览过，看完后我也十分的激动，难道使用 <code>Swift</code> 统一前后端开发的日子就要到了吗？直到最近在毕设的“压迫”下，我才认认真真的学习使用 <code>Swift</code> 开发服务端。目前在 github 上 star 最多的是 <code>Vapor</code>，其次是 <code>Perfect</code>。</p>
<p>为什么选择 <code>Vapor</code>？</p>
<ul>
<li>在 <code>2018 @Swift</code> 大会上虾神对 <code>Swift Serve Side</code> 做了一个 lightning talk，对 <code>Vapor</code> 十分赞扬；</li>
<li>陆陆续续看了网上的一些资料，发现大家对 <code>Vapor</code> 关注度也更高一些；</li>
<li><code>Vapor</code> 在语法和相关 <code>API</code> 的设计上会更加 <code>Swifty</code> 一些；</li>
<li>github 上的所有 <code>Swift Sever Side</code> 框架中它的 <code>star</code> 是最多。</li>
</ul>
<p>但是，在刚开始时估计是学校的网太破了，导致生成 <code>Xcode</code> 模版文件时真的是巨慢！！！有一次等了二十分钟，还失败了！中途切回了 <code>Perfect</code>，然后 <code>Perfect</code> 同样也有一些其它问题，又换回来。</p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><h3 id="下载-vapor"><a href="#下载-vapor" class="headerlink" title="下载 vapor"></a>下载 <code>vapor</code></h3><p><a target="_blank" rel="noopener" href="https://docs.vapor.codes/3.0/install/macos/">详见官网</a>。</p>
<h3 id="运行-Hello-world"><a href="#运行-Hello-world" class="headerlink" title="运行 Hello, world!"></a>运行 <code>Hello, world!</code></h3><ul>
<li><code>vapor new yourProjectName</code>。创建模版工程，当然可以加上 <code>--template=api</code> 来创建提供对应服务的模版工程，但我测试了一下好像跟其它模版工程没什么区别。</li>
<li><code>vapor xcode</code>。创建 Xcode 工程，特别特别慢，而且会有一定几率失败。（估计是学校的网太破</li>
</ul>
<h3 id="MVC-——-M"><a href="#MVC-——-M" class="headerlink" title="MVC —— M"></a>MVC —— M</h3><p><code>Vapor</code> 默认是 <code>SQLite</code> 的<strong>内存</strong>数据库。我原本想看看 <code>Vapor</code> 自带的 <code>SQLite</code> 数据库中的表，但没翻着，最后想了一下，这是内存数据库啊，也就是说，每次 <code>Run</code> 数据都会被清空。可以从 <code>config.swift</code> 中看出：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">let</span> sqlite <span class="operator">=</span> <span class="keyword">try</span> <span class="type">SQLiteDatabase</span>(storage: .memory)</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>在 <code>Vapor</code> 文档中写了推荐使用 <code>Fluent</code> ORM 框架进行数据库表结构的管理，刚开始我并不了解关于 <code>Fluent</code> 的任何内容，可以查看模版文件中的 <code>Todo.swift</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FluentSQLite</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Todo</span>: <span class="title class_">SQLiteModel</span> &#123;</span><br><span class="line">    <span class="comment">/// 唯一标识符</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">Int</span>?</span><br><span class="line">    <span class="keyword">var</span> title: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">id</span>: <span class="type">Int</span>? <span class="operator">=</span> <span class="literal">nil</span>, <span class="params">title</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.id <span class="operator">=</span> id</span><br><span class="line">        <span class="keyword">self</span>.title <span class="operator">=</span> title</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 实现数据库操作。如增加表字段，更新表结构</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Todo</span>: <span class="title class_">Migration</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 允许从 HTTP 消息中编解码出对应数据</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Todo</span>: <span class="title class_">Content</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 允许使用动态的使用在路由中定义的参数</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Todo</span>: <span class="title class_">Parameter</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>从模版文件中的 <code>Model</code> 可以看出来创建一张表结构相当于是<strong>描述一个类</strong>，之前有使用过 <code>Django</code> 的经验，看到 <code>Vapor</code> 的这种 ORM 这么 <code>Swifty</code> 确实眼前一亮。<code>Vapor</code> 同样可以遵循 <code>MVC</code> 设计模式进行构建，在生成的模版文件中也确实是基于 <code>MVC</code> 去做的。</p>
<h3 id="MVC-——-C"><a href="#MVC-——-C" class="headerlink" title="MVC —— C"></a>MVC —— C</h3><p>如果我们只使用 <code>Vapor</code> 做 <code>API</code> 服务，可以不用管 <code>V</code> 层，在 <code>Vapor</code> 的“视图”部分，使用的 <code>Leaf</code> 库做的渲染，具体细节因为没学习过不做展开。</p>
<p>而对于 <code>C</code> 来说，整体的思路跟以往写 App 时的思路大致相当，在 <code>C</code> 层中处理好数据和视图的关系，只不过此处只需要处理数据和数据之间的关系就好了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Controls basic CRUD operations on `Todo`s.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TodoController</span> &#123;</span><br><span class="line">    <span class="comment">/// Returns a list of all `Todo`s.</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">index</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;[<span class="type">Todo</span>]&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Todo</span>.query(on: req).all()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Saves a decoded `Todo` to the database.</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">create</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">Todo</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> req.content.decode(<span class="type">Todo</span>.<span class="keyword">self</span>).flatMap &#123; todo <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> todo.save(on: req)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Deletes a parameterized `Todo`.</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">delete</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">HTTPStatus</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> req.parameters.next(<span class="type">Todo</span>.<span class="keyword">self</span>).flatMap &#123; todo <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> todo.delete(on: req)</span><br><span class="line">        &#125;.transform(to: .ok)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上模版文件中生成的 <code>TodoController</code> 可以看出，大量结合了 <code>Future</code> 异步特性，初次接触会有点懵，有同学推荐结合 <code>PromiseKit</code> 其实会更香。</p>
<h2 id="从-SQLite-到-MySQL"><a href="#从-SQLite-到-MySQL" class="headerlink" title="从 SQLite 到 MySQL"></a>从 <code>SQLite</code> 到 <code>MySQL</code></h2><p>为什么要换，原因很简单，不是 <code>SQLite</code> 不好，仅仅只是因为没用过而已。这部分 <code>Vapor</code> 官方文档讲的不够系统，虽然都点到了但是过于分散，而且感觉 <code>Vapor</code> 的文档是不是跟 Apple 学了一套，细节都不展开，遇到一些字段问题得亲自写下代码，然后看实现和注释，不写之前很难知道在描述什么。</p>
<h3 id="Package-swift"><a href="#Package-swift" class="headerlink" title="Package.swift"></a><code>Package.swift</code></h3><p>在 <code>Package.swift</code> 中写下对应库依赖，</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> PackageDescription</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> package <span class="operator">=</span> <span class="type">Package</span>(</span><br><span class="line">    name: <span class="string">&quot;Unicorn-Server&quot;</span>,</span><br><span class="line">    products: [</span><br><span class="line">        .library(name: <span class="string">&quot;Unicorn-Server&quot;</span>, targets: [<span class="string">&quot;App&quot;</span>]),</span><br><span class="line">    ],</span><br><span class="line">    dependencies: [</span><br><span class="line">        .package(url: <span class="string">&quot;https://github.com/vapor/vapor.git&quot;</span>, from: <span class="string">&quot;3.0.0&quot;</span>),</span><br><span class="line">        <span class="comment">// here</span></span><br><span class="line">        .package(url: <span class="string">&quot;https://github.com/vapor/fluent-mysql.git&quot;</span>, from: <span class="string">&quot;3.0.0&quot;</span>),</span><br><span class="line">    ],</span><br><span class="line">    targets: [</span><br><span class="line">        .target(name: <span class="string">&quot;App&quot;</span>,</span><br><span class="line">                dependencies: [</span><br><span class="line">                    <span class="string">&quot;Vapor&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;FluentMySQL&quot;</span></span><br><span class="line">            ]),</span><br><span class="line">        .target(name: <span class="string">&quot;Run&quot;</span>, dependencies: [<span class="string">&quot;App&quot;</span>]),</span><br><span class="line">        .testTarget(name: <span class="string">&quot;AppTests&quot;</span>, dependencies: [<span class="string">&quot;App&quot;</span>])</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>触发更新</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vapor xcode</span><br></pre></td></tr></table></figure>

<p><code>Vapor</code> 搞了我几次，更新依赖的时候特别慢，而且还更新失败，导致我现在每次更新时都要去确认一遍依赖是否更新成功。</p>
<h3 id="更新-ORM"><a href="#更新-ORM" class="headerlink" title="更新 ORM"></a>更新 ORM</h3><p>更新成功后，我们就可以根据之前生成的模版文件 <code>Todo.swift</code> 的样式改成 <code>MySQL</code> 版本的 ORM：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FluentMySQL</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="comment">/// A simple user.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">User</span>: <span class="title class_">MySQLModel</span> &#123;</span><br><span class="line">    <span class="comment">/// The unique identifier for this user.</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">Int</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// The user&#x27;s full name.</span></span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// The user&#x27;s current age in years.</span></span><br><span class="line">    <span class="keyword">var</span> age: <span class="type">Int</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// Creates a new user.</span></span><br><span class="line">    <span class="keyword">init</span>(<span class="params">id</span>: <span class="type">Int</span>? <span class="operator">=</span> <span class="literal">nil</span>, <span class="params">name</span>: <span class="type">String</span>, <span class="params">age</span>: <span class="type">Int</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.id <span class="operator">=</span> id</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">        <span class="keyword">self</span>.age <span class="operator">=</span> age</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Allows `User` to be used as a dynamic migration.</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span>: <span class="title class_">Migration</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Allows `User` to be encoded to and decoded from HTTP messages.</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span>: <span class="title class_">Content</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Allows `User` to be used as a dynamic parameter in route definitions.</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span>: <span class="title class_">Parameter</span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>以上是我新建的 User Model，换成 Todo Model 也是一样的。改动的地方只有两个，<code>import FluentMySQL</code> 和继承自 <code>MySQLModel</code>。这点还算不错，通过 <code>Fluent</code> 抹平了各种数据库的使用，不管你底层是什么数据库，都只需要导入然后切换继承即可。</p>
<h3 id="修改-config-swift"><a href="#修改-config-swift" class="headerlink" title="修改 config.swift"></a>修改 <code>config.swift</code></h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FluentMySQL</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 应用初始化完会被调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">configure</span>(<span class="keyword">_</span> <span class="params">config</span>: <span class="keyword">inout</span> <span class="type">Config</span>, <span class="keyword">_</span> <span class="params">env</span>: <span class="keyword">inout</span> <span class="type">Environment</span>, <span class="keyword">_</span> <span class="params">services</span>: <span class="keyword">inout</span> <span class="type">Services</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="comment">// === mysql ===</span></span><br><span class="line">    <span class="comment">// 首先注册数据库</span></span><br><span class="line">    <span class="keyword">try</span> services.register(<span class="type">FluentMySQLProvider</span>())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册路由到路由器中进行管理</span></span><br><span class="line">    <span class="keyword">let</span> router <span class="operator">=</span> <span class="type">EngineRouter</span>.default()</span><br><span class="line">    <span class="keyword">try</span> routes(router)</span><br><span class="line">    services.register(router, as: <span class="type">Router</span>.<span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册中间件</span></span><br><span class="line">    <span class="comment">// 创建一个中间件配置文件</span></span><br><span class="line">    <span class="keyword">var</span> middlewares <span class="operator">=</span> <span class="type">MiddlewareConfig</span>()</span><br><span class="line">    <span class="comment">// 错误中间件。捕获错误并转化到 HTTP 返回体中</span></span><br><span class="line">    middlewares.use(<span class="type">ErrorMiddleware</span>.<span class="keyword">self</span>)</span><br><span class="line">    services.register(middlewares)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// === mysql ===</span></span><br><span class="line">    <span class="comment">// 配置 MySQL 数据库</span></span><br><span class="line">    <span class="keyword">let</span> mysql <span class="operator">=</span> <span class="type">MySQLDatabase</span>(config: <span class="type">MySQLDatabaseConfig</span>(hostname: <span class="string">&quot;&quot;</span>, port: <span class="number">3306</span>, username: <span class="string">&quot;&quot;</span>, password: <span class="string">&quot;&quot;</span>, database: <span class="string">&quot;&quot;</span>, capabilities: .default, characterSet: .utf8mb4_unicode_ci, transport: .unverifiedTLS))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册 SQLite 数据库配置文件到数据库配置中心</span></span><br><span class="line">    <span class="keyword">var</span> databases <span class="operator">=</span> <span class="type">DatabasesConfig</span>()</span><br><span class="line">    <span class="comment">// === mysql ===</span></span><br><span class="line">    databases.add(database: mysql, as: .mysql)</span><br><span class="line">    services.register(databases)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置迁移文件。相当于注册表</span></span><br><span class="line">    <span class="keyword">var</span> migrations <span class="operator">=</span> <span class="type">MigrationConfig</span>()</span><br><span class="line">    <span class="comment">// === mysql ===</span></span><br><span class="line">    migrations.add(model: <span class="type">User</span>.<span class="keyword">self</span>, database: .mysql)</span><br><span class="line">    services.register(migrations)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意 <code>MySQLDatabaseConfig</code> 的配置信息。如果我们的 <code>MySQL</code> 版本在 <strong>8</strong> 以上，目前只能选择 <code>unverifiedTLS</code> 进行验证连接MySQL容器时使用的安全连接选项，也即 <code>transport</code> 字段。在代码中用 <code>// === mysql ===</code> 进行标记的代码块是跟模版文件中使用 <code>SQLite</code> 所不同的地方。</p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>运行工程，进入 <code>MySQL</code> 进行查看。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show tables;</span></span><br><span class="line">+----------------------+</span><br><span class="line">| Tables_in_unicorn_db |</span><br><span class="line">+----------------------+</span><br><span class="line">| fluent               |</span><br><span class="line">| Sticker              |</span><br><span class="line">| User                 |</span><br><span class="line">+----------------------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">desc User;</span></span><br><span class="line">+-------+--------------+------+-----+---------+----------------+</span><br><span class="line">| Field | Type         | Null | Key | Default | Extra          |</span><br><span class="line">+-------+--------------+------+-----+---------+----------------+</span><br><span class="line">| id    | bigint(20)   | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name  | varchar(255) | NO   |     | NULL    |                |</span><br><span class="line">| age   | bigint(20)   | NO   |     | NULL    |                |</span><br><span class="line">+-------+--------------+------+-----+---------+----------------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure>

<p><code>Vapor</code> 不像 <code>Django</code> 那般在生成的表加上前缀，而是你 ORM 类名是什么，最终生成的表名就是什么，这点很喜欢！</p>
<h3 id="增加一个字段"><a href="#增加一个字段" class="headerlink" title="增加一个字段"></a>增加一个字段</h3><p><code>Vapor</code> 同样也没有像 <code>Django</code> 那么强大的工作流，很多人都说 <code>Perfect</code> 像 <code>Django</code>，我自己的认为 <code>Vapor</code> 像 <code>Flask</code>。</p>
<p>对 <code>Vapor</code> 修改表字段，不仅仅只是修改 <code>Model</code> 属性这么简单，同样也不像 <code>Django</code> 中修改完后，执行 <code>python manage.py makemigrations</code> 和 <code>python manage.py migrate</code> 就结束了，我们需要自己创建迁移文件，自己写清楚此次表结构到底发生了什么改变。</p>
<p>在泊学的<a target="_blank" rel="noopener" href="https://boxueio.com/series/vapor-fluent/ebook/473">这篇文章</a>中推荐在 <code>App</code> 目录下创建一个 <code>Migrations group</code>，方便操作。但我思考了一下，这么做势必会造成 <code>Model</code> 和对应的迁移文件割裂，然后在另外一个上级文件夹中又要对不同迁移文件所属的 <code>Model</code> 做切分，这很显然是有一些问题的。最后，我脑子冒出了一个非常可怕的想法：“<code>Django</code> 是一个非常强大、架构非常良好的框架！”。</p>
<p>最后我的目录是这样的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Models</span><br><span class="line">└── User</span><br><span class="line">    ├── Migrations</span><br><span class="line">    │   ├── 19-04-30-AddUserCreatedTime.swift</span><br><span class="line">    │   └── 19-04-30-DeleteUserNickname.swift</span><br><span class="line">    ├── UserController.swift</span><br><span class="line">    └── User.swift</span><br></pre></td></tr></table></figure>

<p>这是 <code>Django</code> 中的一个 <code>app</code> 文件树：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">user_avatar</span><br><span class="line">├── __init__.py</span><br><span class="line">├── admin.py</span><br><span class="line">├── apps.py</span><br><span class="line">├── migrations</span><br><span class="line">│   ├── 0001_initial.py</span><br><span class="line">│   ├── 0002_auto_20190303_2154.py</span><br><span class="line">│   ├── 0002_auto_20190303_2209.py</span><br><span class="line">│   ├── 0003_auto_20190303_2154.py</span><br><span class="line">│   ├── 0003_auto_20190322_1638.py</span><br><span class="line">│   ├── 0004_merge_20190408_2131.py</span><br><span class="line">│   └── __init__.py</span><br><span class="line">├── models.py</span><br><span class="line">├── tests.py</span><br><span class="line">├── urls.py</span><br><span class="line">└── views.py</span><br></pre></td></tr></table></figure>

<p>已经删除掉了一些非重要信息。可以看到，<code>Django</code> 的 <code>app</code> 文件夹结构非常好！注意看 <code>migrations</code> 文件夹下的迁移文件命名。如果开发能力不错的话，我们是可以做到与业务无关的 <code>app</code> 发布供他人直接导入到工程中。</p>
<p>不过关于工程文件的管理，这是一个智者见智的事情啦～对于我个人来说，我反而更加喜欢 <code>Vapor</code>&#x2F;<code>Flask</code> 一系，因为需要什么再加什么，整个设计模式也可以按照自己的喜好来做。</p>
<p>给 <code>User</code> Model 添加一个 <code>createdTime</code> 字段。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FluentMySQL</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AddUserCreatedTime</span>: <span class="title class_">MySQLMigration</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">prepare</span>(<span class="params">on</span> <span class="params">conn</span>: <span class="type">MySQLConnection</span>) -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">MySQLDatabase</span>.update(<span class="type">User</span>.<span class="keyword">self</span>, on: conn, closure: &#123;</span><br><span class="line">            <span class="variable">$0</span>.field(for: \<span class="type">User</span>.fluentCreatedAt)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">revert</span>(<span class="params">on</span> <span class="params">conn</span>: <span class="type">MySQLConnection</span>) -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">        <span class="comment">// 直接返回</span></span><br><span class="line">        <span class="keyword">return</span> conn.future()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="删除一个字段"><a href="#删除一个字段" class="headerlink" title="删除一个字段"></a>删除一个字段</h4><p>使用 <code>Swift</code> 开发服务端很容易受到使用 <code>Swift</code> 做其它开发的影响。刚开始时我确实认为在 <code>Model</code> 中把需要删除的字段删除就好了，然而运行工程后去查数据库发现并不是这么一回事。</p>
<p>首先，我们需要先创建一个文件来写 <code>Model</code> 的迁移代码，但这不是必须的，你可以把该 <code>Model</code> 后续需要进行表字段的 CURD 都写在同一个文件中，因为每一个迁移都是一个 <code>struct</code>。我的做法是像上文所说，对每一个迁移都做新文件，并且每一个迁移文件都写上“时间”和“做了什么”。</p>
<p>在 <code>prepare</code> 方法中调用 <code>DatabaseKit</code> 的 <code>create</code> 方法，<code>Fluent</code> 支持大部分数据库，且都基于 <code>DatabaseKit</code> 对支持的这些大部分数据库做了二次封装。</p>
<p>通过 <code>Fluent</code> 对表删除一个字段，需要在<strong>增加表字段时就要做好</strong>，否则需要重新写一个迁移文件，例如，我们可以把上文代码中的 <code>revert</code> 方法改为：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">revert</span>(<span class="params">on</span> <span class="params">conn</span>: <span class="type">MySQLConnection</span>) -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">MySQLDatabase</span>.update(<span class="type">User</span>.<span class="keyword">self</span>, on: conn, closure: &#123;</span><br><span class="line">        <span class="variable">$0</span>.deleteField(for: \<span class="type">User</span>.fluentCreatedAt)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果此时我们直接运行工程，是不会有任何效果的，因为直接运行工程并不会触发 <code>revert</code> 方法，我们需要激活 <code>Vapor</code> 两个命令，在 <code>config.swift</code> 中：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> commands <span class="operator">=</span> <span class="type">CommandConfig</span>.default()</span><br><span class="line">commands.useFluentCommands()</span><br><span class="line">services.register(commands)</span><br></pre></td></tr></table></figure>

<p>接着，在终端中输入：<code> vapor build &amp;&amp; vapor run revert</code> 即可撤销上一次新增的字段。使用 <code> vapor build &amp;&amp; vapor run revert  -all</code> 可以撤销全部生成的表。</p>
<p>问题来了！当我的 <code>revert</code> 方法中写明当撤销迁移时，把表进行删除，一切正常。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="type">MySQLDatabase</span>.delete(<span class="type">User</span>.<span class="keyword">self</span>, on: conn)</span><br></pre></td></tr></table></figure>

<p>但如果我要执行当撤销迁移时，把表中 <code>fluentCreatedAt</code> 字段删除时，失败！！！搞了 N 久也没有成功，几乎翻遍了网上所有内容，也没法解决，几乎都是这么写然后执行撤回迁移命令就生效了。</p>
<p>如果我们从 <code>Model</code> 中已经提前删除掉了需要移除的字段，那么在 <code>migrations</code> 中，这个字段就没法被索引，因为已经被移除了，那么就无法被 <code>deleteField</code>。最终我的解决办法是，因为这个字段已经不需要了，那么直接写 SQL 删除掉这个字段。</p>
<p>隐约觉得，这不是 <code>Vapor</code> 的最佳实践。</p>
<h3 id="修改一个表字段"><a href="#修改一个表字段" class="headerlink" title="修改一个表字段"></a>修改一个表字段</h3><p>暂留。</p>
<h2 id="Auth"><a href="#Auth" class="headerlink" title="Auth"></a>Auth</h2><p>在 <code>Vapor</code> 中有两种对用户鉴权的方式。一为适用 <code>API</code> 服务的 <code>Stateless</code> 方式，二为适用于 <code>Web</code> 的 <code>Sessions</code>，</p>
<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// swift-tools-version:4.0</span></span><br><span class="line"><span class="keyword">import</span> PackageDescription</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> package <span class="operator">=</span> <span class="type">Package</span>(</span><br><span class="line">    name: <span class="string">&quot;Unicorn-Server&quot;</span>,</span><br><span class="line">    products: [</span><br><span class="line">        .library(name: <span class="string">&quot;Unicorn-Server&quot;</span>, targets: [<span class="string">&quot;App&quot;</span>]),</span><br><span class="line">    ],</span><br><span class="line">    dependencies: [</span><br><span class="line">        .package(url: <span class="string">&quot;https://github.com/vapor/vapor.git&quot;</span>, from: <span class="string">&quot;3.0.0&quot;</span>),</span><br><span class="line">        .package(url: <span class="string">&quot;https://github.com/SwiftyJSON/SwiftyJSON.git&quot;</span>, from: <span class="string">&quot;4.0.0&quot;</span>),</span><br><span class="line">        .package(url: <span class="string">&quot;https://github.com/vapor/fluent-mysql.git&quot;</span>, from: <span class="string">&quot;3.0.0&quot;</span>),</span><br><span class="line">        <span class="comment">// 添加 auth</span></span><br><span class="line">        .package(url: <span class="string">&quot;https://github.com/vapor/auth.git&quot;</span>, from: <span class="string">&quot;2.0.0&quot;</span>),</span><br><span class="line">    ],</span><br><span class="line">    targets: [</span><br><span class="line">        .target(name: <span class="string">&quot;App&quot;</span>,</span><br><span class="line">                dependencies: [</span><br><span class="line">                    <span class="string">&quot;Vapor&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;SwiftyJSON&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;FluentMySQL&quot;</span>,</span><br><span class="line">                    <span class="comment">// 添加 auth</span></span><br><span class="line">                    <span class="string">&quot;Authentication&quot;</span></span><br><span class="line">            ]),</span><br><span class="line">        .target(name: <span class="string">&quot;Run&quot;</span>, dependencies: [<span class="string">&quot;App&quot;</span>]),</span><br><span class="line">        .testTarget(name: <span class="string">&quot;AppTests&quot;</span>, dependencies: [<span class="string">&quot;App&quot;</span>])</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>执行 <code>vapor xcode</code> 拉取依赖并重新生成 <code>Xcode</code> 工程。</p>
<h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><p>在 <code>config.swift</code> 中增加：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">configure</span>(<span class="keyword">_</span> <span class="params">config</span>: <span class="keyword">inout</span> <span class="type">Config</span>, <span class="keyword">_</span> <span class="params">env</span>: <span class="keyword">inout</span> <span class="type">Environment</span>, <span class="keyword">_</span> <span class="params">services</span>: <span class="keyword">inout</span> <span class="type">Services</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> services.register(<span class="type">AuthenticationProvider</span>())</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Basic-Authorization"><a href="#Basic-Authorization" class="headerlink" title="Basic Authorization"></a>Basic Authorization</h3><p>简单来说，该方式就是验证密码。我们需要维护一个做 <code>Basic Authorization</code> 方式进行鉴权的 <code>Path</code> 集合。请求属于该集合中的 <code>Path</code> 时，都需要把用户名和密码用 <code>:</code> 进行连接成新的字符串，且做 <code>base64</code> 加密，例如，<code>username</code> 为 <code>pjhubs</code>，<code>password</code> 为 <code>pjhubs123</code>，则，拼接后的结果为 <code>pjhubs:pjhubs123</code>，加密完的结果为 <code>cGpodWJzOnBqaHViczEyMw==</code>。按照如下格式添加到每次发起 <code>HTTP</code> 请求的 <code>header</code> 中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Basic cGpodWJzOnBqaHViczEyMw==</span><br></pre></td></tr></table></figure>

<h3 id="Bearer-Authorization"><a href="#Bearer-Authorization" class="headerlink" title="Bearer Authorization"></a>Bearer Authorization</h3><p>当用户登录成功后，我们应该返回一个完整的 <code>token</code> 用于标识该用户已经在我们系统中登录且验证成功，并让该 <code>token</code> 和用户进行关联。使用 <code>Bearer Authorization</code> 方式进行权限验证，我们需要自行生成 <code>token</code>，可以使用任何方法进行生成，<code>Vapor</code> 官方并没有提供对应的生成工具，只要能够保持全局唯一即可。每次进行 <code>HTTP</code> 请求时，把 <code>token</code> 按照如下格式直接添加到 <code>HTTP request</code> 中，假设此次请求的 <code>token</code> 为 <code>pxoGJUtBVn7MXWoajWH+iw==</code>，则完整的 <code>HTTP header</code> 为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer pxoGJUtBVn7MXWoajWH+iw==</span><br></pre></td></tr></table></figure>

<h3 id="创建-Token-Model"><a href="#创建-Token-Model" class="headerlink" title="创建 Token Model"></a>创建 <code>Token</code> Model</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"><span class="keyword">import</span> FluentMySQL</span><br><span class="line"><span class="keyword">import</span> Authentication</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Token</span>: <span class="title class_">MySQLModel</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">Int</span>?</span><br><span class="line">    <span class="keyword">var</span> userId: <span class="type">User</span>.<span class="type">ID</span></span><br><span class="line">    <span class="keyword">var</span> token: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> fluentCreatedAt: <span class="type">Date</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">token</span>: <span class="type">String</span>, <span class="params">userId</span>: <span class="type">User</span>.<span class="type">ID</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.token <span class="operator">=</span> token</span><br><span class="line">        <span class="keyword">self</span>.userId <span class="operator">=</span> userId</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Token</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> user: <span class="type">Parent</span>&lt;<span class="type">Token</span>, <span class="type">User</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> parent(\.userId)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 `BearerAuthenticatable` 协议，并返回绑定的 `tokenKey` 以告知使用 `Token` Model 的哪个属性作为真正的 `token`</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Token</span>: <span class="title class_">BearerAuthenticatable</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> tokenKey: <span class="type">WritableKeyPath</span>&lt;<span class="type">Token</span>, <span class="type">String</span>&gt; &#123; <span class="keyword">return</span> \<span class="type">Token</span>.token &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Token</span>: <span class="title class_">Migration</span> &#123; &#125;</span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Token</span>: <span class="title class_">Content</span> &#123; &#125;</span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Token</span>: <span class="title class_">Parameter</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 `Authentication.Token` 协议，使 `Token` 成为 `Authentication.Token`</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Token</span>: <span class="title class_">Authentication</span>.<span class="title class_">Token</span> &#123;</span><br><span class="line">    <span class="comment">// 指定协议中的 `UserType` 为自定义的 `User`</span></span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">UserType</span> <span class="operator">=</span> <span class="type">User</span></span><br><span class="line">    <span class="comment">// 置顶协议中的 `UserIDType` 为自定义的 `User.ID`</span></span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">UserIDType</span> <span class="operator">=</span> <span class="type">User</span>.<span class="type">ID</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// `token` 与 `user` 进行绑定</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> userIDKey: <span class="type">WritableKeyPath</span>&lt;<span class="type">Token</span>, <span class="type">User</span>.<span class="type">ID</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> \<span class="type">Token</span>.userId</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Token</span> &#123;</span><br><span class="line">    <span class="comment">/// `token` 生成</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">func</span> <span class="title function_">generate</span>(<span class="params">for</span> <span class="params">user</span>: <span class="type">User</span>) <span class="keyword">throws</span> -&gt; <span class="type">Token</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> random <span class="operator">=</span> <span class="keyword">try</span> <span class="type">CryptoRandom</span>().generateData(count: <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> <span class="type">Token</span>(token: random.base64EncodedString(), userId: user.requireID())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a>添加配置</h3><p>在 <code>config.swift</code> 中写下 <code>Token</code> 的配置信息。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrations.add(model: <span class="type">Token</span>.<span class="keyword">self</span>, database: .mysql)</span><br></pre></td></tr></table></figure>

<h3 id="修改-User-Model"><a href="#修改-User-Model" class="headerlink" title="修改 User Model"></a>修改 <code>User</code> Model</h3><p>让 <code>User</code> 和 <code>Token</code> 进行关联。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"><span class="keyword">import</span> FluentMySQL</span><br><span class="line"><span class="keyword">import</span> Authentication</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">User</span>: <span class="title class_">MySQLModel</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">Int</span>?</span><br><span class="line">    <span class="keyword">var</span> phoneNumber: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> nickname: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> password: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>(<span class="params">id</span>: <span class="type">Int</span>? <span class="operator">=</span> <span class="literal">nil</span>,</span><br><span class="line">         <span class="params">phoneNumber</span>: <span class="type">String</span>,</span><br><span class="line">         <span class="params">password</span>: <span class="type">String</span>,</span><br><span class="line">         <span class="params">nickname</span>: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.id <span class="operator">=</span> id</span><br><span class="line">        <span class="keyword">self</span>.nickname <span class="operator">=</span> nickname</span><br><span class="line">        <span class="keyword">self</span>.password <span class="operator">=</span> password</span><br><span class="line">        <span class="keyword">self</span>.phoneNumber <span class="operator">=</span> phoneNumber</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span>: <span class="title class_">Migration</span> &#123; &#125;</span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span>: <span class="title class_">Content</span> &#123; &#125;</span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span>: <span class="title class_">Parameter</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 `TokenAuthenticatable`。当 `User` 中的方法需要进行 `token` 验证时，需要关联哪个 Model</span></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span>: <span class="title class_">TokenAuthenticatable</span> &#123;</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">TokenType</span> <span class="operator">=</span> <span class="type">Token</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">toPublic</span>() -&gt; <span class="type">User</span>.<span class="type">Public</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">User</span>.<span class="type">Public</span>(id: <span class="keyword">self</span>.id<span class="operator">!</span>, nickname: <span class="keyword">self</span>.nickname)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">/// User 对外输出信息，因为并不想把整个 `User` 实体的所有属性都暴露出去</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Public</span>: <span class="title class_">Content</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> id: <span class="type">Int</span></span><br><span class="line">        <span class="keyword">let</span> nickname: <span class="type">String</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extension</span> <span class="title class_">Future</span> <span class="title class_">where</span> <span class="title class_">T</span>: <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">toPublic</span>() -&gt; <span class="type">Future</span>&lt;<span class="type">User</span>.<span class="type">Public</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> map(to: <span class="type">User</span>.<span class="type">Public</span>.<span class="keyword">self</span>) &#123; (user) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> user.toPublic()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="路由方法"><a href="#路由方法" class="headerlink" title="路由方法"></a>路由方法</h3><p>使用 <code>Basic Authorization</code> 方式做用户鉴权后，我们就可以把需要使用鉴权的方法和非鉴权的方法按照如下方式在 <code>UserController.swift</code> 文件分开进行路由，如果这个文件你没有，需要新建一个。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"><span class="keyword">import</span> Authentication</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">UserController</span>: <span class="title class_">RouteCollection</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重载 `boot` 方法，在控制器中定义路由</span></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">boot</span>(<span class="params">router</span>: <span class="type">Router</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> userRouter <span class="operator">=</span> router.grouped(<span class="string">&quot;api&quot;</span>, <span class="string">&quot;user&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 正常路由</span></span><br><span class="line">        <span class="keyword">let</span> userController <span class="operator">=</span> <span class="type">UserController</span>()</span><br><span class="line">        router.post(<span class="string">&quot;register&quot;</span>, use: userController.register)</span><br><span class="line">        router.post(<span class="string">&quot;login&quot;</span>, use: userController.login)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// `tokenAuthMiddleware` 该中间件能够自行寻找当前 `HTTP header` 的 `Authorization` 字段中的值，并取出与该 `token` 对应的 `user`，并把结果缓存到请求缓存中供后续其它方法使用</span></span><br><span class="line">        <span class="comment">// 需要进行 `token` 鉴权的路由</span></span><br><span class="line">        <span class="keyword">let</span> tokenAuthenticationMiddleware <span class="operator">=</span> <span class="type">User</span>.tokenAuthMiddleware()</span><br><span class="line">        <span class="keyword">let</span> authedRoutes <span class="operator">=</span> userRouter.grouped(tokenAuthenticationMiddleware)</span><br><span class="line">        authedRoutes.get(<span class="string">&quot;profile&quot;</span>, use: userController.profile)</span><br><span class="line">        authedRoutes.get(<span class="string">&quot;logout&quot;</span>, use: userController.logout)</span><br><span class="line">        authedRoutes.get(<span class="string">&quot;&quot;</span>, use: userController.all)</span><br><span class="line">        authedRoutes.get(<span class="string">&quot;delete&quot;</span>, use: userController.delete)</span><br><span class="line">        authedRoutes.get(<span class="string">&quot;update&quot;</span>, use: userController.update)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">logout</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">HTTPResponse</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> user <span class="operator">=</span> <span class="keyword">try</span> req.requireAuthenticated(<span class="type">User</span>.<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> <span class="type">Token</span></span><br><span class="line">            .query(on: req)</span><br><span class="line">            .filter(\<span class="type">Token</span>.userId, .equal, user.requireID())</span><br><span class="line">            .delete()</span><br><span class="line">            .transform(to: <span class="type">HTTPResponse</span>(status: .ok))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">profile</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">User</span>.<span class="type">Public</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> user <span class="operator">=</span> <span class="keyword">try</span> req.requireAuthenticated(<span class="type">User</span>.<span class="keyword">self</span>)</span><br><span class="line">        <span class="keyword">return</span> req.future(user.toPublic())</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">all</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;[<span class="type">User</span>.<span class="type">Public</span>]&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">User</span>.query(on: req).decode(data: <span class="type">User</span>.<span class="type">Public</span>.<span class="keyword">self</span>).all()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">register</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">User</span>.<span class="type">Public</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> req.content.decode(<span class="type">User</span>.<span class="keyword">self</span>).flatMap(&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$0</span>.save(on: req).toPublic()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">delete</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">HTTPStatus</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> req.parameters.next(<span class="type">User</span>.<span class="keyword">self</span>).flatMap &#123; todo <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">return</span> todo.delete(on: req)</span><br><span class="line">            &#125;.transform(to: .ok)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">func</span> <span class="title function_">update</span>(<span class="keyword">_</span> <span class="params">req</span>: <span class="type">Request</span>) <span class="keyword">throws</span> -&gt; <span class="type">Future</span>&lt;<span class="type">User</span>.<span class="type">Public</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> flatMap(to: <span class="type">User</span>.<span class="type">Public</span>.<span class="keyword">self</span>, req.parameters.next(<span class="type">User</span>.<span class="keyword">self</span>), req.content.decode(<span class="type">User</span>.<span class="keyword">self</span>)) &#123; (user, updatedUser) <span class="keyword">in</span></span><br><span class="line">            user.nickname <span class="operator">=</span> updatedUser.nickname</span><br><span class="line">            user.password <span class="operator">=</span> updatedUser.password</span><br><span class="line">            <span class="keyword">return</span> user.save(on: req).toPublic()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是，如果某个路由方法需要从 <code>token</code> 关联的用户取信息才需要 <code>let user = try req.requireAuthenticated(User.self)</code> 这行代码取用户，否则如果我们仅仅只是需要对某个路由方法进行鉴权，只需要加入到 <code>tokenAuthenticationMiddleware</code> 的路由组中即可。</p>
<p>并且， 我们不需要传入当前登录用户有关的任何信息，仅仅只需要一个 <code>token</code> 即可。</p>
<h3 id="修改-config-swift-1"><a href="#修改-config-swift-1" class="headerlink" title="修改 config.swift"></a>修改 <code>config.swift</code></h3><p>最后，把我们实现了 <code>RouteCollection</code> 协议的 <code>userController</code> 加入到 <code>config.swift</code> 中进行路由注册即可。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">func</span> <span class="title function_">routes</span>(<span class="keyword">_</span> <span class="params">router</span>: <span class="type">Router</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="comment">// 用户路由</span></span><br><span class="line">    <span class="keyword">let</span> usersController <span class="operator">=</span> <span class="type">UserController</span>()</span><br><span class="line">    <span class="keyword">try</span> router.register(collection: usersController)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="修改-server-默认端口号"><a href="#修改-server-默认端口号" class="headerlink" title="修改 server 默认端口号"></a>修改 server 默认端口号</h2><p>在 <code>config.swift</code> 中注册 <code>NIOServerConfig</code> 服务。例如如下所示，我修改为了 <code>8001</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myService <span class="operator">=</span> <span class="type">NIOServerConfig</span>.default(port: <span class="number">8001</span>)</span><br><span class="line">services.register(myService)</span><br></pre></td></tr></table></figure>

<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>感觉当一些设计模式的 tips 杂糅在一起后，就特别像 <code>Django</code>。但是和 <code>Django</code> 又有很大的不同，在一些细节上 <code>Vapor</code> 处理的不够好，看得云里雾里的，文档不够简单明了，或许，老外都这样？</p>
<p>在这次的学习当中，心中冒出了很多次“为什么我要用这个破东西？”，但每次冒出这个想法时，最后都忍住了，因为这可是 <code>Swift</code> 啊！</p>
<p>github 地址：<a target="_blank" rel="noopener" href="https://github.com/windstormeye/Unicorn-Server">Unicorn-Server</a></p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2019/05/05/talk01/">我的大学（讲稿）</a><a class="next" href="/2019/04/27/im/">搞事情之如何快速完成 IM</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 15px;">总结</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 15px;">比赛</a> <a href="/tags/Cocos/" style="font-size: 15px;">Cocos</a> <a href="/tags/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/" style="font-size: 15px;">游戏开发</a> <a href="/tags/DiDi/" style="font-size: 15px;">DiDi</a> <a href="/tags/internship/" style="font-size: 15px;">internship</a> <a href="/tags/Flutter/" style="font-size: 15px;">Flutter</a> <a href="/tags/%E8%B7%A8%E5%B9%B3%E5%8F%B0/" style="font-size: 15px;">跨平台</a> <a href="/tags/Audio/" style="font-size: 15px;">Audio</a> <a href="/tags/Ping/" style="font-size: 15px;">Ping</a> <a href="/tags/%E5%BC%B9%E5%B9%95/" style="font-size: 15px;">弹幕</a> <a href="/tags/%E9%A1%B5%E9%9D%A2%E4%BC%A0%E5%80%BC/" style="font-size: 15px;">页面传值</a> <a href="/tags/HUD/" style="font-size: 15px;">HUD</a> <a href="/tags/Swift/" style="font-size: 15px;">Swift</a> <a href="/tags/%E5%BC%80%E6%BA%90/" style="font-size: 15px;">开源</a> <a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 15px;">项目</a> <a href="/tags/PhotosKit/" style="font-size: 15px;">PhotosKit</a> <a href="/tags/React-Native/" style="font-size: 15px;">React-Native</a> <a href="/tags/swift/" style="font-size: 15px;">swift</a> <a href="/tags/Weex/" style="font-size: 15px;">Weex</a> <a href="/tags/Apple/" style="font-size: 15px;">Apple</a> <a href="/tags/%E6%84%9F%E6%83%B3/" style="font-size: 15px;">感想</a> <a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 15px;">博客</a> <a href="/tags/%E4%BA%91/" style="font-size: 15px;">云</a> <a href="/tags/%E9%9A%8F%E6%83%B3/" style="font-size: 15px;">随想</a> <a href="/tags/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8/" style="font-size: 15px;">字节跳动</a> <a href="/tags/%E6%9C%88%E5%BA%A6%E6%80%BB%E7%BB%93/" style="font-size: 15px;">月度总结</a> <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 15px;">随笔</a> <a href="/tags/CMake/" style="font-size: 15px;">CMake</a> <a href="/tags/makefile/" style="font-size: 15px;">makefile</a> <a href="/tags/%E7%BC%96%E8%AF%91/" style="font-size: 15px;">编译</a> <a href="/tags/CodeLab/" style="font-size: 15px;">CodeLab</a> <a href="/tags/%E5%B0%91%E5%84%BF%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">少儿编程</a> <a href="/tags/%E6%88%91%E7%9A%84%E5%A4%A7%E5%AD%A6/" style="font-size: 15px;">我的大学</a> <a href="/tags/%E5%9B%9E%E5%BF%86%E5%BD%95/" style="font-size: 15px;">回忆录</a> <a href="/tags/crash/" style="font-size: 15px;">crash</a> <a href="/tags/%E9%AA%91%E8%A1%8C/" style="font-size: 15px;">骑行</a> <a href="/tags/%E8%87%AA%E8%A1%8C%E8%BD%A6/" style="font-size: 15px;">自行车</a> <a href="/tags/fcc/" style="font-size: 15px;">fcc</a> <a href="/tags/%E5%88%86%E4%BA%AB/" style="font-size: 15px;">分享</a> <a href="/tags/%E6%B8%B8%E6%88%8F/" style="font-size: 15px;">游戏</a> <a href="/tags/ifLab/" style="font-size: 15px;">ifLab</a> <a href="/tags/%E6%8A%80%E6%9C%AF/" style="font-size: 15px;">技术</a> <a href="/tags/%E5%BB%BA%E7%AB%99/" style="font-size: 15px;">建站</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 15px;">面试</a> <a href="/tags/%E7%A7%9F%E6%88%BF/" style="font-size: 15px;">租房</a> <a href="/tags/iBistu/" style="font-size: 15px;">iBistu</a> <a href="/tags/macOS/" style="font-size: 15px;">macOS</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 15px;">编译原理</a> <a href="/tags/%E7%9D%A1%E9%AD%94/" style="font-size: 15px;">睡魔</a> <a href="/tags/Netflix/" style="font-size: 15px;">Netflix</a> <a href="/tags/%E6%91%84%E5%BD%B1/" style="font-size: 15px;">摄影</a> <a href="/tags/%E4%BD%9C%E5%93%81/" style="font-size: 15px;">作品</a> <a href="/tags/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/" style="font-size: 15px;">开发日志</a> <a href="/tags/App/" style="font-size: 15px;">App</a> <a href="/tags/%E4%BA%A7%E5%93%81%E6%80%9D%E8%80%83/" style="font-size: 15px;">产品思考</a> <a href="/tags/Playground/" style="font-size: 15px;">Playground</a> <a href="/tags/%E5%B7%A5%E4%BD%9C/" style="font-size: 15px;">工作</a> <a href="/tags/SwiftUI/" style="font-size: 15px;">SwiftUI</a> <a href="/tags/%E5%BD%B1%E8%A7%86%E5%89%A7/" style="font-size: 15px;">影视剧</a> <a href="/tags/WWDC/" style="font-size: 15px;">WWDC</a> <a href="/tags/%E5%AD%97%E8%8A%82/" style="font-size: 15px;">字节</a> <a href="/tags/%E8%B7%91%E6%AD%A5/" style="font-size: 15px;">跑步</a> <a href="/tags/%E9%A9%AC%E6%8B%89%E6%9D%BE/" style="font-size: 15px;">马拉松</a> <a href="/tags/%E8%BF%90%E5%8A%A8/" style="font-size: 15px;">运动</a> <a href="/tags/%E8%B6%8A%E9%87%8E%E8%B7%91/" style="font-size: 15px;">越野跑</a> <a href="/tags/%E6%84%9F%E8%B0%A2/" style="font-size: 15px;">感谢</a> <a href="/tags/%E6%BB%B4%E6%BB%B4/" style="font-size: 15px;">滴滴</a> <a href="/tags/%E6%80%9D%E8%80%83/" style="font-size: 15px;">思考</a> <a href="/tags/%E6%97%85%E8%A1%8C/" style="font-size: 15px;">旅行</a> <a href="/tags/%E6%84%9F%E6%80%A7/" style="font-size: 15px;">感性</a> <a href="/tags/%E9%9D%92%E5%B2%9B/" style="font-size: 15px;">青岛</a> <a href="/tags/%E5%BE%92%E6%AD%A5/" style="font-size: 15px;">徒步</a> <a href="/tags/Unity/" style="font-size: 15px;">Unity</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/WatchOS/" style="font-size: 15px;">WatchOS</a> <a href="/tags/Combine/" style="font-size: 15px;">Combine</a> <a href="/tags/django/" style="font-size: 15px;">django</a> <a href="/tags/%E5%AE%9E%E4%B9%A0/" style="font-size: 15px;">实习</a> <a href="/tags/%E5%BE%AE%E4%BF%A1/" style="font-size: 15px;">微信</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">小程序</a> <a href="/tags/UML/" style="font-size: 15px;">UML</a> <a href="/tags/%E6%90%9E%E4%BA%8B%E6%83%85%E7%B3%BB%E5%88%97/" style="font-size: 15px;">搞事情系列</a> <a href="/tags/%E4%B8%83%E7%89%9B%E4%BA%91/" style="font-size: 15px;">七牛云</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/Mybatis/" style="font-size: 15px;">Mybatis</a> <a href="/tags/Junit/" style="font-size: 15px;">Junit</a> <a href="/tags/log4j/" style="font-size: 15px;">log4j</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/Spring-MVC/" style="font-size: 15px;">Spring MVC</a> <a href="/tags/%E5%9B%BD%E9%99%85%E5%8C%96/" style="font-size: 15px;">国际化</a> <a href="/tags/%E6%BC%94%E8%AE%B2/" style="font-size: 15px;">演讲</a> <a href="/tags/%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/" style="font-size: 15px;">即时通讯</a> <a href="/tags/side-project/" style="font-size: 15px;">side project</a> <a href="/tags/Qt/" style="font-size: 15px;">Qt</a> <a href="/tags/C-%E8%B7%A8%E7%AB%AF/" style="font-size: 15px;">C++ 跨端</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/" style="font-size: 15px;">响应式</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 联系我</i></div><ul></ul><a href="https://github.com/windstormeye" title="GitHub - PJHubs" target="_blank">GitHub - PJHubs</a><ul></ul><a href="https://www.xiaohongshu.com/user/profile/5f2cd0360000000001001470" title="小红书 - PJHubs" target="_blank">小红书 - PJHubs</a><ul></ul><a href="https://www.instagram.com/pjhubs/" title="Instagram - PJHubs" target="_blank">Instagram - PJHubs</a><ul></ul><a href="https://space.bilibili.com/25392474" title="BiliBili - PJHubs" target="_blank">BiliBili - PJHubs</a><ul></ul><a href="https://twitter.com/wengpeijun" title="Twitter - PJHubs" target="_blank">Twitter - PJHubs</a><ul></ul><a href="." title="邮箱 - 877302410@qq.com" target="_blank">邮箱 - 877302410@qq.com</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 PJHubs</div></div></div><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>